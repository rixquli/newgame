<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>World of Capitalist</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    ></script>

    <style>
      body {
        margin: 0;
        font-family: "Roboto", sans-serif;
        color: white;
      }
      #crosshair {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 2%;
        transform: translate(-50%, -50%);
      }
      #ammo_container {
        position: absolute;
        right: 5%;
        bottom: 5%;
        font-size: 3em;
      }
      #score_container {
        position: absolute;
        right: 5%;
        top: 5%;
        font-size: 3em;
      }
      #progress {
        position: absolute;
        bottom: 9%;
        left: 0;
        width: 0;
        height: 2%;
        background-color: white;
      }
      #health_container {
        position: absolute;
        bottom: 8%;
        left: 5%;
        width: 18%;
        height: 2%;
        border: 1px solid #ffffff;
      }
      #health_progress {
        position: absolute;
        background-color: #ffffff;
        width: 100%;
        height: 100%;
      }
      #game_hud {
        visibility: hidden;
      }
      #menu {
        position: absolute;
        width: 100%;
        height: 100%;
        background-image: url("/img/image_accueil_jeu.jpg");
        background-repeat: no-repeat;
        background-position: center;
        background-size: cover;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        visibility: hidden;
      }
      h1 {
        font-family: "Libre Barcode 39 Text", cursive;
        font-size: 4em;
      }
      button {
        background-color: rgba(0, 0, 0, 0);
        color: rgb(221, 221, 221);
        font-size: 1.5em;
        border: none;
        cursor: pointer;
        margin-top: 10%;
        font-weight: 700;
      }
      #debug {
        position: absolute;
        right: 5%;
        top: 5%;
      }
      #death_screen {
        position: absolute;
        width: 100%;
        height: 100%;
        background-color: black;
        opacity: 0.4;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        visibility: hidden;
      }
      #death_screen div {
        opacity: 1;
      }
      #right {
        border: #000;
        border-style: solid;
        margin: 5px;
      }
      #left {
        border: #000;
        border-style: solid;
        margin: 5px;
      }
      #selectMenu {
        color: black;
        position: absolute;
        width: 100%;
        height: 100%;
        background-color: rgb(0, 195, 255);
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        visibility: hidden;
      }
      .joinParty {
        position: absolute;
        top: 0;
      }
      #partyList {
        width: 80%;
        background-color: wheat;
      }
      #info {
        position: fixed;
        top: 0;
        left: 0;
        background-color: aqua;
        z-index: 2;
        visibility: visible;
      }
      #gridSelector {
        position: fixed;
        visibility: hidden;
        right: 0;
        top: 12vh;
        background-color: chocolate;
        border-radius: 10px;
        height: auto;
        max-width: 50vw;
      }
      #gridSelector > button {
        font-size: 1em;
      }
      div#collectMenu {
        display: none;
        height: 50vh;
        overflow-y: scroll;
      }
      #buildMenu {
        display: flex;
        flex-direction: column;
        height: 50vh;
        overflow-y: scroll;
      }
      #buildMenu > button {
        border: solid #000;
        border-radius: 10px;
      }
      #collectMenu > button {
        border: solid #000;
        border-radius: 10px;
      }
      .buildable {
        margin-top: 0.2em;
        margin-bottom: 0.2em;
      }
      #resources {
        position: fixed;
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        z-index: 3;
        visibility: hidden;
        top: 0px;
        height: 10vh;
        gap: 50px;
        width: 100vw;
      }

      #resources div {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      .villagerList {
        margin: 5px;
        padding: 2px;
        border: solid black;
        border-radius: 10px;
      }
      input.color {
        visibility: hidden;
      }
      img.villagerColor {
        width: 100%;
      }

      dd.villagerName {
        display: flex;
      }
      dd.villagerName > label {
        width: min-content;
      }
      .jobButton {
        font-size: 1.5em;
        line-height: 0.8em;
      }
      .job {
        font-size: 0.6em;
        margin-bottom: 10px;
      }
      .houseNumber {
        font-size: 1.7em;
      }

      #error {
        position: fixed;
        bottom: 0;
        color: red;
      }
      .loadingScreen {
        visibility: hidden;
        position: fixed;
        display: flex;
        flex-direction: column-reverse;
        align-items: center;
        height: 100vh;
        width: 100%;
        background-color: black;
        z-index: 10;
      }

      #loadingScreen {
        width: 100vw;
      }
      .joystick {
        visibility: hidden;
        position: absolute;
      }
      canvas#joystick {
        position: fixed;
        bottom: 10px;
      }
      button.startJoinGame {
        color: cornflowerblue;
        margin: 0;
      }
      div#partyList {
        gap: 10px;
        display: flex;
        flex-direction: column;
        border-radius: 10px;
      }
      .party {
        border: solid;
        border-radius: 10px;
        gap: 10px;
      }
      .form-row {
        display: flex;
        flex-wrap: wrap;
        margin-right: -5px;
        margin-left: -5px;
      }
      .modalShop {
        color: black;
        font-family: Arial, Helvetica, sans-serif;
      }
      .produit {
        margin-top: 0;
        margin-right: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 40%;
      }
      .produit img {
        width: 100%;
      }
      .produit img:hover {
        opacity: 0.8;
      }
      div#nav-home {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-around;
      }
      .inventory {
        color: #000;
      }
      .modal-body.inventoryContent {
        background-color: bisque;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-around;
      }
      .inventoryItem {
        margin-top: 0;
        margin-right: 10px;
        margin-bottom: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        background-image: url("/img/PngItem_4889400.png");
        background-repeat: no-repeat;
        background-position: center;
        background-size: cover;
      }
      .inventoryItem img {
        height: 25vmin;
      }
      .inventoryItem img:hover {
        opacity: 0.8;
      }
      .itemCount {
        display: flex;
        align-items: center;
        flex-direction: column;
        width: 7.6em;
      }
      .echap {
        visibility: hidden;
        color: #ffffff;
        position: fixed;
        bottom: 0;
      }
    </style>
    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
      }
    </style>

    <!--script
      async
      src="https://ga.jspm.io/npm:es-module-shims@1.5.17/dist/es-module-shims.js"
    ></script-->

    <script
      defer
      src="https://cdn.jsdelivr.net/gh/kripken/ammo.js@HEAD/builds/ammo.js"
    ></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/seedrandom/3.0.5/seedrandom.min.js"></script>
    <!--script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.141.0/build/three.module.js"
        }
      }
    </script-->
    <script src="/socket.io/socket.io.js"></script>

    <!-- <script
    type="text/javascript"
    src="/node_modules/physijs/src/physi.js"
  ></script> -->
    <script type="module">
      //import * as THREE from "three";

      import * as THREE from "https://unpkg.com/three@0.141.0/build/three.module.js";
      //from "https://cdn.jsdelivr.net/npm/three@0.118/build/three.module.js";

      // import { OrbitControls } from "https://unpkg.com/three@0.141.0/examples/jsm/controls/OrbitControls.js";
      // import { OrbitControls } from "https://unpkg.com/three@0.141.0/examples/fonts/helvetiker_regular.typeface.json";
      // import Stats from "./jsm/libs/stats.module.js";

      import { GLTFLoader } from "/js/GLTFLoader.js";

      import { FBXLoader } from "/js/FBXLoader.js";
      import { FontLoader } from "/js/FontLoader.js";
      import { TextGeometry } from "/js/TextGeometry.js";
      import { otherPlayer } from "/js/otherPlayer.js";
      import { Villager } from "/js/villager.js";
      import { TimerResource } from "/js/timerResource.js";
      import { Joystick } from "/js/joystick.js";
      import { Inventory } from "/js/inventoryManager.js";
      //import * as HOUSE from "/structure/house/01_medieval_house_low_poly.glb"
      //https://unpkg.com/three@0.141.0/examples/jsm/geometries/TextGeometry.js
      //https://unpkg.com/three@0.141.0/examples/jsm/curves/NURBSUtils.js

      //import { Pathfinding } from 'https://unpkg.com/three-pathfinding@1.1.0/src/index.js';

      //import randomP from "/random.json"
      const randomP = [
        {
          houseVillager: 0.1,
          stone: 1.1,
          farmWithoutWheat: 3,
          farmWithWheat: 10,
          wood: 5,
        },
      ];

      // import bos from "/character.gltf";

      // import { Octree } from "https://unpkg.com/three@0.141.0/examples//jsm/math/Octree.js";
      // import { OctreeHelper } from "https://unpkg.com/three@0.141.0/examples//jsm/helpers/OctreeHelper.js";

      // import { Capsule } from "https://unpkg.com/three@0.141.0/examples//jsm/math/Capsule.js";

      // import { GUI } from "https://unpkg.com/three@0.141.0/examples//jsm/libs/lil-gui.module.min.js";

      //import { annuaire } from "/annuaire.js";

      class App {
        constructor() {
          this.socket = io();
          //this.socket.on("pos", (d) => (console.log(d)));
          this.clock = new THREE.Clock();
          this.STEPS_PER_FRAME = 5;
          this.GRAVITY = -7.5;

          this.rigidBodies = [];
          this.currentPosition = new THREE.Vector3();
          this.currentLookat = new THREE.Vector3();

          this.assets = [];
          //this.zombieAnims = [];
          // this.tempTransform = null;

          // keyboard controls
          this.speed = 0.5;
          this._keys = {
            moveForward: false,
            moveBackward: false,
            moveLeft: false,
            moveRight: false,
            space: false,
            shift: false,
          };

          this.rotationView = -1;

          this.tempVec = new THREE.Vector3();

          this.player = null;
          this.playerIsLoading = false;
          // moveDirection = { left: 0, right: 0, forward: 0, back: 0 };
          this.STATE = { DISABLE_DEACTIVATION: 4 };

          this.mouse = new THREE.Vector2();
          this.clickableObjs = [];
          this.raycaster = new THREE.Raycaster();
          this.randomP = randomP[0];
          this.previousFrame = null;

          this.isMouseHover = false;

          this.canCollect = false;

          this.modelReady = false;

          this.players = {};
          this.mainPlayer = null;

          this.animationActions = [];

          this.activeAction;
          this.villagers = [];

          this.houseN = 1;

          this.villagerSpeed = 0.4;
          this.villagerActions = [];
          this.mixer = [];

          this.seed = 0;
          this.mapSize = { x: 20, z: 20 };

          this.playerLastPosition = new THREE.Vector3();
          this.playersAnim = new otherPlayer();
          this.shop = [];
          this.setPos = [];
          this.idealOffset = [0, 30, 40];
          this.Joystick = new Joystick();
          this.inventory = new Inventory();

          this.playerRotation = -1;
          this.socket.on("partyList", (data) => {
            this.partyList = data.map((e) => {
              return e.slice(6);
            });
          });
          this.socket.on("structure", (d) => {
            console.log(Object.keys(d).map((_) => d[_]));
            let structure = Object.keys(d).map((_) => d[_]);

            this.loadStructure(...structure);
          });

          this.init();
          // this.createRender();
          // this.keyboardControls();
          // this.startAmmo();
          // this.update();
        }

        init() {
          this.createRender();
          this.eventResize();
          // this.load();
          this.createLight();
          //this.loadBackground();
          this.SetupStartButton();
          // this.keyboardControls();

          // this.startAmmo();
          // this.update();
          this.preLoader();
          this.ShowMenu();
        }

        preLoader() {
          this.preLoaded = {};
          let loader = (path, type) => {
            new GLTFLoader().load(
              path,
              (gltf) => {
                gltf.scene.scale.set(0, 0, 0);
                this.scene.add(gltf.scene);
                this.preLoaded[type] = gltf.scene;
              },
              undefined,
              (error) => {
                console.error(error);
              }
            );
          };
          loader("/structure/low-poly_rock/scene.gltf", "stone");
          loader("/structure/tree_low-poly_3d_model/scene.gltf", "tree");
        }

        SetupStartButton() {
          document
            .getElementById("start_game")
            .addEventListener("click", () => this.showSelectMenu());
        }

        StartGame = () => {
          window.cancelAnimationFrame(this.update);

          //Create entities and physics
          // this.scene.clear();
          this.Villagers = new Villager(this.scene, this.FBXLoader);
          this.addEvent();

          this.keyboardControls();
          this.mouseControls();
          this.createAmmo();
          //this.createPathfinding()
          document.querySelector("#resources").style.visibility = "visible";
          //this.showResources();
          //this.animFrameId = window.requestAnimationFrame(this.update);
          this.update();
        };

        addEvent() {
          //e,unit, unitN,path,x,y,z,scale,house,rotaion
          document
            .querySelector("#showBuildMenu")
            .addEventListener("click", (e) => this.toggleMenu(e), false);
          document
            .querySelector("#showCollectMenu")
            .addEventListener("click", (e) => this.toggleMenu(e), false);
          document.querySelectorAll(".produit.lootbox").forEach((e) => {
            e.addEventListener("click", (d) => {
              console.log(e.getAttribute("lb-lv"));
              this.inventory.toggleLootbox();
              this.opening();
            });
          });
          document
            .querySelector("#buildHouse")
            .addEventListener(
              "click",
              (e) =>
                this.buildStructure(
                  e,
                  "wood",
                  50,
                  "house/01_medieval_house_low_poly.glb",
                  0,
                  -23,
                  0,
                  2,
                  true,
                  Math.PI / 2,
                  "house"
                ),
              false
            );
          document
            .querySelector("#buildMine")
            .addEventListener(
              "click",
              (e) =>
                this.buildStructure(
                  e,
                  "stone",
                  50,
                  "low-poly_mine/scene.gltf",
                  0.5,
                  -28,
                  0.5,
                  1,
                  false,
                  -Math.PI / 2,
                  "mine"
                ),
              false
            );
          document
            .querySelector("#buildBlacksmithHouse")
            .addEventListener(
              "click",
              (e) =>
                this.buildStructure(
                  e,
                  "stone",
                  50,
                  "blacksmiths_house/scene.gltf",
                  2,
                  -28,
                  0,
                  0.1,
                  false,
                  Math.PI / 2,
                  "blacksmithHouse"
                ),
              false
            );
          document
            .querySelector("#buildShop")
            .addEventListener(
              "click",
              (e) =>
                this.buildStructure(
                  e,
                  "stone",
                  50,
                  "small_store/scene.gltf",
                  0,
                  -28,
                  0,
                  0.23,
                  false,
                  0,
                  "shop"
                ),
              false
            );
        }

        toggleMenu(e) {
          e.stopPropagation();
          e.preventDefault();
          $("#buildMenu").toggle();
          $("#collectMenu").toggle();
        }

        opening() {
          this.isOpening = true;

          this.openingScene = new THREE.Scene();

          this.openingCamera = new THREE.PerspectiveCamera(
            60,
            window.innerWidth / window.innerHeight,
            0.001,
            1000
          );
          //0,2,3
          this.openingCamera.position.set(0, 2, 3);
          this.openingCamera.lookAt(0, 1, 0);
          const ambiantLight = new THREE.AmbientLight(0xffffff, 1); // soft white light
          this.openingScene.add(ambiantLight);
          this.light = new THREE.DirectionalLight(0xffffff, 1);
          this.light.position.set(0, 0, 10);
          this.openingScene.add(this.light);
          this.addOpeningScene();
        }

        addOpeningScene() {
          this.FBXLoader.load(
            "/structure/low-poly-pirates-chest/source/PiratesChest.fbx",
            (fbx) => {
              let chest = fbx;
              console.log(chest);
              this.mixerChest = new THREE.AnimationMixer(chest);
              this.openingScene.add(chest);
              chest.position.set(0, 0, 0);
              chest.scale.set(0.007, 0.007, 0.007);
              if (fbx.animations[2]) {
                const animationAction = this.mixerChest.clipAction(
                  fbx.animations[2]
                );
                console.log(animationAction);
                animationAction.clampWhenFinished = true;
                animationAction.repetitions = 1;
                animationAction.play();
              }
              this.mixerChest.addEventListener("finished", (e) => {
                this.openingSpawnItem();
              });
            }
          );
        }

        openingSpawnItem() {
          this.FBXLoader.load(
            "/item/free-stylized-low-poly-swords/source/PP_Free_Swords.fbx",
            (fbx) => {
              let i = Math.floor(Math.random() * 6);
              let item = fbx.children[i];
              item.position.set(0, 1.2, 0);
              item.scale.set(1, 1, 1);
              console.log(fbx);
              this.openingScene.add(item);
              this.inventory.addItem("/img/item/sword(" + (i + 1) + ").png", 1);
              document.querySelector(".echap").style.visibility = "visible";
              document.addEventListener("keydown", (e) => {
                this.exitOpening(e);
              });
            }
          );
        }

        exitOpening(e) {
          if (e.keyCode != 27) return;
          document.removeEventListener("keydown", (e) => {
            this.exitOpening(e);
          });
          document.querySelector(".echap").style.visibility = "hidden";
          this.isOpening = false;
        }

        showSelectMenu(visible = true) {
          document.querySelectorAll(".startGame").forEach((e) => {
            e.addEventListener("click", (e) => {
              this.loading = true;
              document.querySelector(".loadingScreen").style.visibility =
                "visible";
              this.size = [];
              let modalBodyInput =
                exampleModal.querySelector("#recipient-name");
              this.seed =
                exampleModal.querySelector("#recipient-seed").value || 0;
              this.size.x =
                exampleModal.querySelector("#recipient-size-x").value || 20;
              this.size.z =
                exampleModal.querySelector("#recipient-size-z").value || 20;
              console.log(modalBodyInput.value);
              document.getElementById("selectMenu").style.visibility = "hidden";
              this.socket.emit("joinParty", modalBodyInput.value);
              this.StartGame();
            });
          });
          this.addPartyList();

          document.getElementById("menu").style.visibility = "hidden";
          document.getElementById("selectMenu").style.visibility = "visible";
        }

        createParty() {}

        addPartyList() {
          let party = "";
          for (let i = 0; i < this.partyList.length; i++) {
            party =
              party +
              `<div party="${this.partyList[i]}" class="party">${this.partyList[i]}<button party="${this.partyList[i]}" onclick="document.querySelector('.loadingScreen').style.visibility =
                'visible'" class="startJoinGame">Join</button></div>`;
          }
          document.querySelector("#partyList").innerHTML = party;
          document.querySelectorAll(".startJoinGame").forEach((e) => {
            e.addEventListener("click", (e) => {
              this.loading = true;
              document.querySelector(".loadingScreen").style.visibility =
                "visible";
              document.getElementById("selectMenu").style.visibility = "hidden";
              let party = e.target.getAttribute("party");
              console.log(e.target);
              console.log(party);
              this.socket.emit("joinParty", party);
              this.StartGame();
            });
          });
        }

        ShowMenu(visible = true) {
          document.getElementById("menu").style.visibility = visible
            ? "visible"
            : "hidden";
        }

        showResources() {
          document.querySelector("#resources").style.visibility = "visible";
        }

        createRender() {
          this.collisionConfiguration =
            new Ammo.btDefaultCollisionConfiguration();
          this.dispatcher = new Ammo.btCollisionDispatcher(
            this.collisionConfiguration
          );
          this.overlappingPairCache = new Ammo.btDbvtBroadphase();
          this.solver = new Ammo.btSequentialImpulseConstraintSolver();

          this.dynamicsWorld = new Ammo.btDiscreteDynamicsWorld(
            this.dispatcher,
            this.overlappingPairCache,
            this.solver,
            this.collisionConfiguration
          );
          this.dynamicsWorld.setGravity(new Ammo.btVector3(0, this.GRAVITY, 0));

          this.renderer = new THREE.WebGLRenderer({
            antialias: true,
            alpha: false,
            powerPreference: "high-performance",
            //depthBuffer: false
          });
          //this.render.setPixelRatio(window.devicePixelRatio);
          this.renderer.setSize(window.innerWidth, window.innerHeight);
          document
            .querySelector("#three")
            .appendChild(this.renderer.domElement);
          //this.renderer.physicallyCorrectLights = true

          this.scene = new THREE.Scene();

          this.camera = new THREE.PerspectiveCamera(
            60,
            window.innerWidth / window.innerHeight,
            1,
            500
          );
          this.camera.position.set(0, 10, 50);
          this.camera.lookAt(0, -30, 0);

          // this.scene.background = new THREE.Color(0xffffff);

          this.loader = new THREE.TextureLoader();
          this.GLTFLoader = new GLTFLoader();
          this.FBXLoader = new FBXLoader();
        }

        eventResize() {
          window.addEventListener("resize", () => {
            this.renderer.setSize(window.innerWidth, window.innerHeight);
            this.camera.aspect = window.innerWidth / window.innerHeight;
            this.camera.updateProjectionMatrix();
            this.openingCamera.aspect = window.innerWidth / window.innerHeight;
            this.openingCamera.updateProjectionMatrix();
          });
        }

        createLight() {
          const ambiantLight = new THREE.AmbientLight(0xffffff, 1); // soft white light
          this.scene.add(ambiantLight);
          this.light = new THREE.DirectionalLight(0xffffff, 1);
          this.light.position.set(0, 0, 10);
          this.scene.add(this.light);
        }

        // SetAnim(name, clip) {
        //   const action = this.mixer.clipAction(clip);
        //   this.animations[name] = { clip, action };
        // }

        loadAction(path, name) {
          console.log(path);
          this.FBXLoader.load(
            path,
            (fbx) => {
              const animationAction = this.mixer.clipAction(fbx.animations[0]);
              this.animationActions[name] = animationAction;
            },
            undefined,
            (error) => {
              console.error(error);
            }
          );
        }

        setAction(toAction) {
          //console.log(toAction);
          // toAction.play();
          if (toAction != this.activeAction && toAction != undefined) {
            this.lastAction = this.activeAction;
            this.activeAction = toAction;
            //lastAction.stop()
            this.lastAction.fadeOut(0.5);
            toAction.reset();
            toAction.fadeIn(1);
            toAction.play();
            this.socket.emit("action", toAction._clip.name);
          }
        }

        keyboardControlsDown(e) {
          var key = e.keyCode;
          // console.log(key);

          switch (key) {
            case 90:
            case 38:
              this._keys.moveForward = 1;
              break;
            case 81:
            case 37:
              // console.log(this.scene.getObjectByName("player"));
              // this.scene.getObjectByName("player").position.y -= 0.9;
              this._keys.moveLeft = 1;
              this.seeAtRight = false;
              //this.setAction(this.animationActions["run"]);
              break;
            case 83:
            case 40:
              this._keys.moveBackward = 1;
              break;
            case 68:
            case 39:
              this._keys.moveRight = 1;
              this.seeAtRight = true;
              //this.setAction(this.animationActions["run"]);
              break;
            case 32:
              // if (this.canJump)
              this.jump = true;
              break;
            case 69:
              this.inventory.toggle();
              break;

            // case 13:
            //   console.log(this.player.userData.physicsBody);
            //   break;
          }
          //this.socket.emit("pos", this.player.position.toArray());
        }

        keyboardControlsUp(e) {
          switch (e.keyCode) {
            case 90:
            case 38:
              this._keys.moveForward = 0;
              break;
            case 81:
            case 37:
              this._keys.moveLeft = 0;
              if (this._keys.moveRight == 1) {
                this.seeAtLeft = false;
              }
              //this.setAction(this.animationActions["idle"]);
              break;
            case 83:
            case 40:
              this._keys.moveBackward = 0;
              break;
            case 68:
            case 39:
              this._keys.moveRight = 0;
              if (this._keys.moveLeft == 1) {
                this.seeAtRight = false;
              }
              //this.setAction(this.animationActions["idle"]);
              break;
            case 32:
              // if (this.canJump)
              this.jump = false;
              break;
          }
          //this.socket.emit("pos", this.player.position.toArray());
        }

        keyboardControls() {
          window.addEventListener(
            "keydown",
            (e) => this.keyboardControlsDown(e),
            false
          );
          window.addEventListener(
            "keyup",
            (e) => this.keyboardControlsUp(e),
            false
          );
          window.addEventListener("keydown", (e) => this.collect(e), false);
        }

        collect(e) {
          if (this.canCollect != true) return;
          if (e.keyCode != 69) return;
          let obj = this.scene.getObjectByName("click");
          if (!obj || obj.collectable == false) return;

          if (
            Math.round(
              this.player.position.clone().distanceTo(obj.position.clone()) * 10
            ) /
              10 <
            30
          ) {
            new TimerResource(obj, this.scene);
            this.addResources(obj.prop, 5);
          } else {
            document.querySelector("#error").innerHTML = "<p>Too far</p>";
          }
        }

        addResources(value, nbr) {
          document.querySelector(`#${value}Count`).textContent =
            Number(document.querySelector(`#${value}Count`).textContent) + nbr;
        }

        mouseDownCanvas(e) {
          e.preventDefault();
          console.log(e.which);
          this.mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
          this.mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;

          this.raycaster.setFromCamera(this.mouse, this.camera);
          let intersects = this.raycaster.intersectObjects(this.clickableObjs);
          if (e.which == 1) {
            if (intersects.length > 0) {
              if (intersects[0].object.name == "click") {
                intersects[0].object.name = "";
                this.cursor_cube.children.forEach(
                  (e) => (e.material.opacity = 0)
                );
                this.cubePropertiesHidden();
                this.gridSelectorHidden();
                return;
              } else if (intersects[0].object.name == "vendeur") {
                this.inventory.toggleLootbox();
                return;
              }
              if (this.scene.getObjectByName("click") != undefined)
                this.scene.getObjectByName("click").name = "";

              // If there is a match mouse/block (if the array is not empty)
              var SelectedBloc = intersects[0].object; // we choose the first targetable element
              intersects[0].object.name = "click";
              //SelectedBloc.material.color.set( 0xff0000 );
              this.cursor_cube.position.set(
                SelectedBloc.position.x,
                SelectedBloc.position.y,
                SelectedBloc.position.z
              );
              this.cursor_cube.children.forEach(
                (e) => (e.material.opacity = 0.5)
              );
              this.cursor_cube.children.forEach(
                (e) => (e.material.emissive.g = 0.5)
              );
              //this.cursor_cube.material.opacity = 0.5;
              //this.cursor_cube.material.emissive.g = 0.5;
              this.cubeProperties(
                SelectedBloc.position.x,
                SelectedBloc.position.z,
                intersects[0].object.prop,
                intersects[0].object.name,
                intersects[0].object
              );
            }
          } else if (e.which == 3) {
            intersects[0].object.name = "";
            this.cursor_cube.children.forEach((e) => (e.material.opacity = 0));
            this.cubePropertiesHidden();
            this.gridSelectorHidden();
            console.log("attack");
          }
        }

        mouseUp() {
          this.cursor_cube.children.forEach((e) => (e.material.emissive.g = 0));
        }

        mouseControls() {
          const cursor_material = new THREE.MeshPhongMaterial({
            transparent: true,
            opacity: 0,
            color: 0xc0392b,
          });
          //const bMat = new THREE.MeshStandardMaterial({ color: 0x0392b });

          const cursor_geometry = [];
          for (let i = 0; i < 12; i++) {
            cursor_geometry.push(
              new THREE.Mesh(
                new THREE.BoxGeometry(2.5, 4, 2.5),
                cursor_material
              )
            );
          }
          cursor_geometry[0].position.set(-8.75, 0, -8.75);
          cursor_geometry[1].position.set(-6.24, 0, -8.75);
          cursor_geometry[2].position.set(-8.75, 0, -6.24);
          cursor_geometry[3].position.set(8.75, 0, -8.75);
          cursor_geometry[4].position.set(6.24, 0, -8.75);
          cursor_geometry[5].position.set(8.75, 0, -6.24);
          cursor_geometry[6].position.set(8.75, 0, 8.75);
          cursor_geometry[7].position.set(6.24, 0, 8.75);
          cursor_geometry[8].position.set(8.75, 0, 6.24);
          cursor_geometry[9].position.set(-8.75, 0, 8.75);
          cursor_geometry[10].position.set(-6.24, 0, 8.75);
          cursor_geometry[11].position.set(-8.75, 0, 6.24);

          this.cursor_cube = new THREE.Group();
          for (const e of cursor_geometry) {
            this.cursor_cube.add(e);
          }
          //this.cursor_cube.children.forEach((e) => (e.material.opacity = 0));
          this.scene.add(this.cursor_cube);
          document
            .querySelector("#three > canvas")
            .addEventListener(
              "pointerdown",
              (e) => this.mouseDownCanvas(e),
              false
            );
          document.addEventListener("pointerup", (e) => this.mouseUp(e), false);
        }

        buildStructure(
          e,
          unit,
          unitN,
          path,
          x,
          y,
          z,
          scale,
          house,
          rotation,
          prop
        ) {
          e.stopPropagation();
          e.preventDefault();
          console.log(`#${unit}Count`);
          if (this.scene.getObjectByName("click").prop != "plain")
            return (document.querySelector("#error").innerHTML =
              "<p>No Good Place</p>");
          if (document.querySelector(`#${unit}Count`).textContent >= unitN) {
            document.querySelector(`#${unit}Count`).textContent =
              Number(document.querySelector(`#${unit}Count`).textContent) -
              unitN;
            let x_ = Number(document.querySelector("#x").innerHTML);
            let z_ = Number(document.querySelector("#z").innerHTML);
            this.socket.emit("structure", {
              path: path,
              x: x_ + x,
              y: y,
              z: z_ + z,
              scale: scale,
              house: house,
              rotation: rotation,
              prop: prop,
              block: this.scene.getObjectByName("click").id,
            });
          } else {
            document.querySelector("#error").innerHTML =
              "<p>No enought Stone</p>";
          }
        }

        showGridSelector() {
          document.querySelector("#gridSelector").style.visibility = "visible";
        }

        gridSelectorHidden() {
          document.querySelector("#gridSelector").style.visibility = "hidden";
        }

        cubeProperties(x, z, prop, name, obj) {
          //const fragment = document.createDocumentFragment();

          const li = document.querySelector("#info");
          li.style.visibility = "visible";
          //li = document.body.appendChild(document.createElement("div"));
          li.innerHTML = `cube :<br>x:<div id="x">${
            x / 20
          }</div>,z:<div id="z">${z / 20}</div>`;
          this.showGridSelector();
          this.Villagers.addVillagerMenu(x, z);
          console.log(prop);
          if (prop == "plain") {
            this.canCollect = false;
            //li.innerHTML =
            //  li.innerHTML + `<button id="buildHouse">Build house</button>`;
            //document
            //  .querySelector("#buildHouse")
            //  .addEventListener("click", (e) => this.buildHouse(e), false);
          } else if (prop == "stone") {
            this.canCollect = true;
            li.innerHTML = li.innerHTML + `<p>Press E to collect</p>`;
          } else if (prop == "wood") {
            this.canCollect = true;
            li.innerHTML = li.innerHTML + `<p>Press E to collect</p>`;
          }
          //else if (prop == "shop") {
          //  li.innerHTML =
          //    li.innerHTML + `<button id="buildHouse">Build house</button>`;
          //  document
          //    .querySelector("#buildHouse")
          //    .addEventListener("click", (e) => this.buildHouse(e), false);
          //}
          //if (color.g != 1) {
          //  li.innerHTML = li.innerHTML + `<br><button>Harvest</button>`
          //}
          //document.body.appendChild(fragment);
        }

        cubePropertiesHidden() {
          document.querySelector("#info").style.visibility = "hidden";
        }

        //attack() {
        //  this.setAction(this.animationActions["attack"]);
        //}

        //updateMovement() {
        //  // const player = this.scene.getObjectByName("player");
        //  // this.player.position.y = this.player.position.y + 0.2;
        //  // console.log(this.moveLeft);
        //  if (this._keys.moveLeft == 1) {
        //    // console.log("left");
        //    this.rotationView = 1;
        //    this.setAction(this.animationActions["run"]);
        //    // this.player.position.x -= this.speed;
        //  }
        //  if (this._keys.moveRight == 1) {
        //    // console.log("right");
        //    this.rotationView = -1;
        //    this.setAction(this.animationActions["run"]);
        //    // this.player.position.x += this.speed;
        //  }
        //}

        updateJump() {
          if (this.jump) {
            // console.log("jump");
            this.player.position.y = this.player.position.y + 5;
            // canJump = false;
            this.jump = false;
          }
        }

        createAmmo() {
          this.TempTransform = new Ammo.btTransform();
          this.tempVecJump = new Ammo.btVector3();

          //this.setupGraphicsWolrd(Ammo);
          this.createMap();
          this.createUpDown();
          this.CreatePlayer();
          //this.CreatePlayerLoad();
          //this.loadStructure();
        }

        createUpDown() {
          this.GLTFLoader.load(
            "structure/small_store/scene.gltf",
            (gltf) => {
              let quat = { x: 0, y: 0, z: 0, w: 1 },
                pos = [0, -250, 0],
                size = [200, 3, 200],
                mass = 0;

              let structure = gltf.scene;
              structure.position.set(...pos);
              structure.scale.set(2.5, 2.5, 2.5);
              //if (rotation) gltf.scene.rotation.y = rotation;
              structure.name = "Shop";
              //structure.matrixAutoUpdate = false;
              //structure.updateMatrix();
              this.scene.add(structure);

              //   let geometry = new THREE.InstancedBufferGeometry()
              //   structure.traverse( function ( child ) {
              //		if ( child.isMesh ) {
              //			geometry.copy(child.geometry)

              //		}
              //	} );

              const geometry = new THREE.BoxGeometry(...size);
              const material = new THREE.MeshBasicMaterial({
                //transparent: true,
                //opacity: 0,
                color: 0x0f0f0f,
              });

              let blockPlane = new THREE.Mesh(geometry, material);
              blockPlane.position.set(...pos);
              this.scene.add(blockPlane);

              let transform = new Ammo.btTransform();
              transform.setIdentity();
              transform.setOrigin(new Ammo.btVector3(...pos));
              transform.setRotation(
                new Ammo.btQuaternion(quat.x, quat.y, quat.z, quat.w)
              );

              let motionState = new Ammo.btDefaultMotionState(transform);
              let localInertia = new Ammo.btVector3(0, 0, 0);
              let shape = new Ammo.btBoxShape(
                new Ammo.btVector3(size[0] * 0.5, size[1] * 0.5, size[2] * 0.5)
              );
              shape.setMargin(0.05);
              shape.calculateLocalInertia(mass, localInertia);

              let rigidBodyInfo = new Ammo.btRigidBodyConstructionInfo(
                mass,
                motionState,
                shape,
                localInertia
              );

              let rigidBody = new Ammo.btRigidBody(rigidBodyInfo);

              // rigidBody.setFriction(4);
              // rigidBody.setRollingFriction(10);

              this.dynamicsWorld.addRigidBody(rigidBody);
              this.createVendeur();
            },
            undefined,
            (error) => {
              console.error(error);
            }
          );
        }

        createVendeur() {
          const height = 10,
            radius = 10,
            mass = 5,
            scale = { x: 6, y: 25, z: 6 },
            quat = { x: 0, y: 0, z: 0, w: 1 };

          this.GLTFLoader.load(
            "/character/gentle_stickman/scene.gltf",
            (fbx) => {
              this.vendeur = fbx.scene;
              this.vendeur.name = "vendeur";
              this.vendeur.position.set(0, -250, -30);
              this.vendeur.scale.set(4, 4, 4);
              this.scene.add(this.vendeur);
              const geometry = new THREE.BoxGeometry(scale.x, scale.y, scale.z);
              const material = new THREE.MeshBasicMaterial({
                color: 0xff0000,
                opacity: 0,
                transparent: true,
              });

              let blockPlane = new THREE.Mesh(geometry, material);
              blockPlane.name = "vendeur";
              blockPlane.position.set(0, -250, -30);
              this.scene.add(blockPlane);
              this.clickableObjs.push(blockPlane);
            },
            undefined,
            (error) => console.error(error)
          );
        }

        loadBasicStructure(
          structure,
          x,
          y,
          z,
          scale,
          house,
          rotation,
          prop,
          block
        ) {
          let gltf = this.preLoaded[structure].clone();
          gltf.position.set(x * 20, y, z * 20);
          gltf.scale.set(scale, scale, scale);
          if (rotation) gltf.rotation.y = rotation;
          if (prop) this.scene.getObjectById(block).prop = prop;
          gltf.matrixAutoUpdate = false;
          gltf.updateMatrix();
          this.scene.add(gltf);
        }

        loadStructure(structure, x, y, z, scale, house, rotation, prop, block) {
          this.GLTFLoader.load(
            "structure/" + structure,
            (gltf) => {
              gltf.scene.position.set(x * 20, y, z * 20);
              gltf.scene.scale.set(scale, scale, scale);
              if (rotation) gltf.scene.rotation.y = rotation;
              if (house) gltf.scene.name = `house${this.houseN}`;
              if (prop) this.scene.getObjectById(block).prop = prop;
              if (prop == "shop") this.shop.push(gltf.scene);
              gltf.scene.matrixAutoUpdate = false;
              gltf.scene.updateMatrix();

              this.scene.add(gltf.scene);
            },
            undefined,
            (error) => {
              console.error(error);
            }
          );
          if (house) {
            this.Villagers.createVillager(
              [x * 20, -25, z * 20 - 5],
              this.houseN
            );

            this.houseN = this.houseN + 1;
            this.Villagers.houseN = this.houseN;
          }
        }

        setupGraphicsWolrd() {
          let collisionConfiguration =
            new Ammo.btDefaultCollisionConfiguration();
          let dispatcher = new Ammo.btCollisionDispatcher(
            collisionConfiguration
          );
          let overlappingPairCache = new Ammo.btDbvtBroadphase();
          let solver = new Ammo.btSequentialImpulseConstraintSolver();

          this.dynamicsWorld = new Ammo.btDiscreteDynamicsWorld(
            dispatcher,
            overlappingPairCache,
            solver,
            collisionConfiguration
          );
          this.dynamicsWorld.setGravity(new Ammo.btVector3(0, this.GRAVITY, 0));
        }

        average(e) {
          this.total = this.total + 1;
          this.totalAdd = this.totalAdd + e;
        }

        moreRandomNumber(e) {
          let randomNumber = new Math.seedrandom(e)();
          return Math.round(randomNumber * 10000) / 100;
        }

        fullSeed() {
          let worldInGen = this.generatingSeed();
          return worldInGen * 10 ** (worldInGen.toString().length - 2);
        }

        addSeedRandom() {
          let sSeed = this.fullSeed().toString();
          for (let i = 0; i < sSeed.length; i = i + 2) {
            this.seedRandom.push(
              this.moreRandomNumber(
                Number(sSeed.charAt(i) + sSeed.charAt(i + 1))
              )
            );
          }
        }

        createMap() {
          this.CreateSolidFloor(this.size.x, this.size.z);

          this.total = 0;
          this.totalAdd = 0;

          this.generatingSeed = new Math.seedrandom(this.seed);
          this.seedRandom = [];
          //this.sSeed = this.generatingSeed.toString();
          this.structureSeed = 1;
          this.addSeedRandom();
          //for (let i = 0; i < this.sSeed.length; i++) {
          //  this.seedRandom.push(+this.sSeed.charAt(i));
          //}

          this.textureCubeGrass = this.loader.load("img/Cartoon_green.jpg");
          this.textureCubeRock = this.loader.load("img/Andesite.png");
          this.textureCubeFarm = this.loader.load(
            "https://static.wikia.nocookie.net/minecraft_gamepedia/images/3/37/Dirt_Path_%28top_texture%29_JE2_BE2.png"
          );
          for (let x = this.size.x * -0.5; x < this.size.x * 0.5; x++) {
            for (let z = this.size.z * -0.5; z < this.size.z * 0.5; z++) {
              //let random = Math.floor(Math.random() * 100);
              if (
                !this.seedRandom[this.structureSeed] ||
                this.seedRandom[this.structureSeed] == NaN
              ) {
                this.addSeedRandom();
              }
              let random = this.seedRandom[this.structureSeed];
              //console.log(random);
              this.average(random);

              if (random < this.randomP.stone) {
                console.log("stone");
                this.createFloor(x, z, this.textureCubeRock, "stone");
                this.loadBasicStructure("stone", x + 0.1, -25, z - 0.1, 0.13);
              } else if (random < this.randomP.wood) {
                this.createFloor(x, z, this.textureCubeGrass, "wood");
                this.loadBasicStructure("tree", x, -28, z, 0.035);
              } else if (random < this.randomP.farmWithWheat) {
                this.createFloor(x, z, this.textureCubeFarm, "wheat");
                //this.loadStructure("source/Field of wheat--eWhaaKNh755/FieldOfWheat(1).gltf", x, z, 1.2);
              } else if (random < this.randomP.farmWithoutWheat) {
                this.createFloor(x, z, this.textureCubeFarm);
              } else {
                this.createFloor(x, z, this.textureCubeGrass, "plain");
              }
              this.structureSeed++;
            }
          }
          console.log("true average = ", this.totalAdd / this.total);
        }

        createFloor(x, z, texture, property) {
          let position = { x: 20 * x, y: -30, z: 20 * z },
            scale = { x: 20, y: 3, z: 20 },
            quat = { x: 0, y: 0, z: 0, w: 1 },
            mass = 0;

          const geometry = new THREE.BoxGeometry(scale.x, scale.y, scale.z);
          const material = new THREE.MeshBasicMaterial({
            map: texture,
          });

          let blockPlane = new THREE.Mesh(geometry, material);
          blockPlane.position.set(position.x, position.y, position.z);
          if (property) blockPlane.prop = property;
          blockPlane.collectable = true;
          this.scene.add(blockPlane);

          this.clickableObjs.push(blockPlane);
          blockPlane.matrixAutoUpdate = false;
          blockPlane.updateMatrix();
        }

        CreateSolidFloor(x, z) {
          let quat = { x: 0, y: 0, z: 0, w: 1 },
            mass = 0;

          const geometry = new THREE.BoxGeometry(x * 0, 3, z * 0);
          const material = new THREE.MeshBasicMaterial({
            //transparent: true,
            opacity: 0,
            color: 0x000000,
          });

          let blockPlane = new THREE.Mesh(geometry, material);
          blockPlane.position.set(0, -33, 0);
          this.scene.add(blockPlane);

          let transform = new Ammo.btTransform();
          transform.setIdentity();
          transform.setOrigin(new Ammo.btVector3(0, -33, 0));
          transform.setRotation(
            new Ammo.btQuaternion(quat.x, quat.y, quat.z, quat.w)
          );

          let motionState = new Ammo.btDefaultMotionState(transform);
          let localInertia = new Ammo.btVector3(0, 0, 0);
          let shape = new Ammo.btBoxShape(
            new Ammo.btVector3(x * 20 * 0.5, 3 * 0.5, z * 20 * 0.5)
          );
          shape.setMargin(0.05);
          shape.calculateLocalInertia(mass, localInertia);

          let rigidBodyInfo = new Ammo.btRigidBodyConstructionInfo(
            mass,
            motionState,
            shape,
            localInertia
          );

          let rigidBody = new Ammo.btRigidBody(rigidBodyInfo);

          this.dynamicsWorld.addRigidBody(rigidBody);
          blockPlane.matrixAutoUpdate = false;
          blockPlane.updateMatrix();
        }

        CreatePlayer() {
          this.socket.emit("newPlayer");
          this.socket.on("pos", (d) => {
            const [id, anim, rot, pos] = d;
            if (!(id in this.players)) {
              console.log("new chalenger");
              console.log(id);
              let scale = { x: 10, y: 10, z: 10 },
                quat = { x: 0, y: 0, z: 0, w: 1 },
                mass = 5,
                position = { x: 0, y: 10, z: 0 },
                height = 50,
                radius = 0.3;

              if (!this.playerIsLoading) {
                this.playerIsLoading = true;
                this.playerId = id;
                this.CreatePlayerLoad(pos, id);
                console.log("main palyer");
              } else {
                console.log("other");
                this.GLTFLoader.load(
                  "/character/gentle_stickman/scene.gltf",
                  (fbx) => {
                    console.log(fbx);
                    this.players[id] = fbx.scene;
                    this.players[id].position.set(...pos);
                    this.players[id].scale.set(7, 7, 7);

                    this.scene.add(this.players[id]);
                    this.playersAnim.CreatePlayerAnimation(
                      fbx.animations,
                      this.players[id]
                    );
                  },
                  false,
                  (error) => {
                    console.error(error);
                  }
                );
              }
            }
            //if (this.player == this.players[id])
            if (this.players[id]?.position && this.players[id] != this.player) {
              this.players[id].position.set(...pos);
              this.players[id].rotation.set(rot._x, rot._y, rot._z);
              this.playersAnim.setAction(anim, this.players[id].id);
            }
          });
          this.socket.on("deletePlayer", (id) => {
            console.log(id);
            console.log(this.players[id]);
            this.playersAnim.deletePlayer();
            this.scene.remove(this.players[id]);
          });
        }

        rigidBody(object, quat, scale, pos, mass) {
          let transform = new Ammo.btTransform();
          transform.setIdentity();
          transform.setOrigin(new Ammo.btVector3(pos));
          transform.setRotation(
            new Ammo.btQuaternion(quat.x, quat.y, quat.z, quat.w)
          );

          let motionState = new Ammo.btDefaultMotionState(transform);
          let localInertia = new Ammo.btVector3(0, 0, 0);
          //todo peut etre changer 0,5
          let shape = new Ammo.btBoxShape(
            new Ammo.btVector3(scale.x, scale.y, scale.z)
          );

          let rigidBodyInfo = new Ammo.btRigidBodyConstructionInfo(
            mass,
            motionState,
            shape,
            localInertia
          );

          let rigidBody = new Ammo.btRigidBody(rigidBodyInfo);

          rigidBody.setFriction(0);

          rigidBody.setActivationState(this.STATE.DISABLE_DEACTIVATION);

          this.dynamicsWorld.addRigidBody(rigidBody);
          object.userData.physicsBody = rigidBody;
          this.rigidBodies.push(object);
        }

        CreatePlayerLoad(pos, id, mainPlayer) {
          const height = 10,
            radius = 10,
            mass = 5,
            scale = { x: 10, y: 3, z: 10 },
            quat = { x: 0, y: 0, z: 0, w: 1 };

          this.GLTFLoader.load(
            "/character/gentle_stickman/scene.gltf",
            (fbx) => {
              console.log(fbx);
              this.player = fbx.scene;
              this.player.name = "player";
              this.player.position.set(...pos);
              this.player.scale.set(4, 4, 4);

              this.players[id] = fbx.scene;
              this.mixer = new THREE.AnimationMixer(this.players[id]);
              // console.log(fbx);

              if (fbx.animations[0]) {
                const animationAction = this.mixer.clipAction(
                  fbx.animations[0]
                );
                animationAction.play();
                this.activeAction = animationAction;
                this.animationActions["idle"] = this.mixer.clipAction(
                  fbx.animations[0]
                );
                this.animationActions["run"] = this.mixer.clipAction(
                  fbx.animations[1]
                );
              }

              this.scene.add(fbx.scene);

              let transform = new Ammo.btTransform();
              transform.setIdentity();
              transform.setOrigin(new Ammo.btVector3(...pos));
              transform.setRotation(
                new Ammo.btQuaternion(quat.x, quat.y, quat.z, quat.w)
              );

              let motionState = new Ammo.btDefaultMotionState(transform);
              let localInertia = new Ammo.btVector3(0, 0, 0);
              //todo peut etre changer 0,5
              let shape = new Ammo.btBoxShape(
                new Ammo.btVector3(scale.x, scale.y, scale.z)
              );

              let rigidBodyInfo = new Ammo.btRigidBodyConstructionInfo(
                mass,
                motionState,
                shape,
                localInertia
              );

              let rigidBody = new Ammo.btRigidBody(rigidBodyInfo);
              this.playerRigidBody = rigidBody;

              rigidBody.setFriction(0);

              rigidBody.setActivationState(this.STATE.DISABLE_DEACTIVATION);
              rigidBody.setCollisionFlags(16);

              this.dynamicsWorld.addRigidBody(rigidBody);
              this.player.userData.physicsBody = rigidBody;
              if (!this.playerRigidBodyI) this.rigidBodies.push(this.player);
              else this.rigidBodies[this.playerRigidBodyI] = this.player;
              this.playerRigidBodyI = this.rigidBodies.length - 1;

              //this.loadAction("/character/mutant/Idle.fbx", "idle");
              //this.loadAction("/character/mutant/Walking.fbx", "run");
              //this.loadAction("/character/mutant/Jumping.fbx", "jump");
              //this.loadAction("/character/mutant/Mutant Swiping.fbx", "attack");
            },
            (e) => {
              console.log(e);
              console.log(e.loaded / e.total);
              if (e.loaded / e.total == 1) {
                setTimeout(() => {
                  this.modelReady = true;
                }, 2000);
              }
            },
            (error) => {
              console.error(error);
            }
          );
        }

        QueryJump() {
          let dispatcher = this.dynamicsWorld.getDispatcher();
          let numManifolds = dispatcher.getNumManifolds();

          for (let i = 0; i < numManifolds; i++) {
            let contactManifold = dispatcher.getManifoldByIndexInternal(i);
            let numContacts = contactManifold.getNumContacts();

            for (let j = 0; j < numContacts; j++) {
              let contactPoint = contactManifold.getContactPoint(j);
              let distance = contactPoint.getDistance();

              if (distance < 0.1) {
                this.canJump = true;
                return;
              }

              // console.log({
              //   manifoldIndex: i,
              //   contactIndex: j,
              //   distance: distance,
              // });
            }
          }
        }

        updatePhysics(timeElapsed) {
          this.dynamicsWorld.stepSimulation(timeElapsed, 10);

          for (let i = 0; i < this.rigidBodies.length; i++) {
            if (
              this.rigidBodies[i] &&
              this.rigidBodies[i].userData?.physicsBody
            ) {
              let threeObject = this.rigidBodies[i];
              let ammoObject = threeObject.userData.physicsBody;
              let ms = ammoObject.getMotionState();

              if (ms) {
                ms.getWorldTransform(this.TempTransform);
                let pos = this.TempTransform.getOrigin();
                let quat = this.TempTransform.getRotation();

                threeObject.position.set(pos.x(), pos.y(), pos.z());
                threeObject.quaternion.x = quat.x();
                threeObject.quaternion.z = quat.z();
              }
              this.QueryJump();
            }
          }
        }

        movePlayer() {
          if (!this.player) return;
          if (!this.player?.userData) return;
          //if (!this.player.userData?.physicsBody) return;
          //if (this.player?.position?.x)
          //this.playerCurrentPosition = this.player.position
          if (!this.playerLastPosition)
            this.playerLastPosition.copy(this.player.position);
          if (
            this.playerLastPosition.x != this.player.position.x ||
            this.playerLastPosition.y != this.player.position.y ||
            this.playerLastPosition.z != this.player.position.z
          ) {
            this.socket.emit("pos", {
              rotation: this.player.rotation,
              pos: this.player.position.toArray(),
            });

            this.updateShop();
          }

          this.moveDir = new THREE.Vector3();
          const forwardFactor =
            this._keys.moveBackward - this._keys.moveForward ||
            this.Joystick.moveForwardJoystick ||
            0;
          const rightFactor =
            this._keys.moveRight - this._keys.moveLeft ||
            this.Joystick.moveRightJoystick ||
            0;

          const velocity = this.player.userData.physicsBody.getLinearVelocity();

          if (this.jump && this.canJump) {
            //this.setAction(this.animationActions["jump"]);
            velocity.setY(15);
            this.canJump = false;
          }

          if (rightFactor != 0 || forwardFactor != 0) {
            this.setAction(this.animationActions["run"]);
          } else {
            this.setAction(this.animationActions["idle"]);
          }

          //this.Deccelerate(t);
          //this.Accelarate(direction, t);
          //const velocity = this.player.userData.physicsBody.getLinearVelocity();
          const moveVector = this.tempVec.copy(
            new THREE.Vector3(rightFactor, 0, forwardFactor)
          );

          velocity.setX(moveVector.x * 5);
          velocity.setZ(moveVector.z * 5);

          if (this.Joystick.rotationCanvasEnable) {
            this.player.rotation.set(0, this.Joystick.rotationCanvas, 0);
          } else {
            if (rightFactor == 1) {
              if (forwardFactor == 1) {
                this.player.rotation.set(0, Math.PI / (135 / 45), 0);
              } else if (forwardFactor == -1) {
                this.player.rotation.set(0, Math.PI / 1.5, 0);
              } else {
                this.player.rotation.set(0, Math.PI / (90 / 45), 0);
              }
            } else if (rightFactor == -1) {
              if (forwardFactor == 1) {
                this.player.rotation.set(0, Math.PI / (-135 / 45), 0);
              } else if (forwardFactor == -1) {
                this.player.rotation.set(0, Math.PI / -1.5, 0);
              } else {
                this.player.rotation.set(0, Math.PI / (-90 / 45), 0);
              }
            } else if (forwardFactor == -1) {
              this.player.rotation.set(0, Math.PI, 0);
            } else if (forwardFactor == 1) {
              this.player.rotation.set(0, 0, 0);
            }
          }

          this.player.userData.physicsBody.setLinearVelocity(velocity);

          this.playerLastPosition.copy(this.player.position);
        }

        // action(action) {
        //   switch (action) {
        //     case "idle":
        //       this.setAction(this.animationActions[1]);
        //       break;
        //     case "run":
        //       this.setAction(this.animationActions[2]);
        //       break;
        //     case "jump":
        //       this.setAction(this.animationActions[3]);
        //       break;
        //     case "fall":
        //       this.setAction(this.animationActions[4]);
        //       break;
        //     case "die":
        //       this.setAction(this.animationActions[5]);
        //       break;
        //     case "attack":
        //       this.setAction(this.animationActions[6]);
        //       break;
        //     case "hit":
        //       this.setAction(this.animationActions[7]);
        //       break;
        //     case "dead":
        //       this.setAction(this.animationActions[8]);
        //       break;
        //     // default:
        //     //   this.setAction(this.animationActions[1]);
        //     //   break;
        //   }
        // }

        thirdPersonCameraUpdate(timeElapsed) {
          if (!this.player) return;
          const playerPosition = this.player.position;

          const idealOffset = new THREE.Vector3(...this.idealOffset);
          idealOffset.add(this.player.position);
          const idealLookat = new THREE.Vector3(0, 0, 0);
          idealLookat.add(this.player.position);

          // const t = 0.05;
          // const t = 4.0 * timeElapsed;
          const t = 1.0 - Math.pow(0.001, timeElapsed);

          this.currentPosition.lerp(idealOffset, t);
          this.currentLookat.lerp(idealLookat, t);

          this.camera.position.copy(this.currentPosition);
          this.camera.lookAt(this.currentLookat);
        }

        //update = () => {
        //  //const currentFrame = this.scene.time.now
        //  //if (this.previousFrame==null) {
        //  //  this.previousFrame = currentFrame
        //  //}
        //
        //  //if (!this.modelReady) return;
        //  this.renderer.render(this.scene, this.camera);
        //  // requestAnimationFrame(() => this.update());
        //  this.delta = this.clock.getDelta() * 2;
        //
        //  //let timeElapsed = currentFrame -this.previousFrame
        //  let timeElapsed = this.clock.getElapsedTime();
        //  const timeElapsedS = timeElapsed * 0.001;
        //
        //  if (this.modelReady) {
        //    this.mixer.update(timeElapsed);
        //  }
        //  //console.log(this.player.position);
        //
        //  this.thirdPersonCameraUpdate(timeElapsed);
        //  this.movePlayer();
        //
        //  if (this.playerBB)
        //    this.playerBB
        //      .copy(this.player.geometry.boundingBox)
        //      .applyMatrix4(this.player.matrixWorld);
        //
        //  // this.updateMovement();
        //  // this.updateJump();
        //
        //  if (this.dynamicsWorld) this.updatePhysics(timeElapsed);
        //
        //  //if (this.mixer) {
        //  //  // console.log(this.mixer.time);
        //  //  this.mixer.update(timeElapsedS);
        //  //}
        //  this.animFrameId = window.requestAnimationFrame(this.update);
        //};

        updateShop() {
          for (let i = 0; i < this.shop.length; i++) {
            if (
              Math.round(
                this.player.position
                  .clone()
                  .distanceTo(this.shop[i].position.clone()) * 10
              ) /
                10 <
              5
            ) {
              this.tpPlayer([0, -250, 0], [0, 20, 30]);
            }
          }
          if (
            Math.round(
              this.player.position
                .clone()
                .distanceTo(new THREE.Vector3(0, -245, 60)) * 10
            ) /
              10 <
            5
          ) {
            this.tpPlayer(this.playerPositionBefore, [0, 20, 30]);
          }
        }

        tpPlayer(pos, camera) {
          this.scene.remove(this.scene.getObjectByName("player"));
          this.dynamicsWorld.removeRigidBody(this.playerRigidBody);
          if (this.rigidBodies[this.playerRigidBodyI])
            delete this.rigidBodies[this.playerRigidBodyI];
          this.CreatePlayerLoad(pos, this.playerId);
          this.idealOffset = camera;
          this.playerPositionBefore = this.player.position.toArray();
          this.playerPositionBefore[2] = this.player.position.z + 10;
          console.log(this.playerPositionBefore);
        }

        update() {
          //const currentFrame = this.scene.time.now
          window.requestAnimationFrame((t) => {
            if (!this.previousFrame) {
              this.previousFrame = t;
            }
            if (!this.isOpening) {
              this.step(t);
              this.renderer.render(this.scene, this.camera);
            } else if (this.mixerChest) {
              this.mixerChest.update(this.clock.getDelta());
              this.renderer.render(this.openingScene, this.openingCamera);
            }

            this.previousFrame = t;
            this.update();
            //if (this.mixer) {
            //  // console.log(this.mixer.time);
            //  this.mixer.update(timeElapsedS);
            //}
          });
        }

        step(t) {
          if (this.mixer && this.modelReady && this.player && this.loading) {
            this.loading = false;
            //const myModalAlternative = new bootstrap.Modal('#lootbox').toggle()
            document.querySelector(".loadingScreen").style.visibility =
              "hidden";
            if (window.mobileAndTabletCheck()) {
              document.querySelector(".joystick").style.visibility = "visible";
              this.Joystick.canvasSetUp();
            }
          }

          //if (!this.modelReady) return;
          // requestAnimationFrame(() => this.update());
          this.delta = this.clock.getDelta();

          let timeElapsed = t - this.previousFrame;
          const timeElapsedS = timeElapsed * 0.001;

          if (this.mixer && this.modelReady && this.player) {
            this.mixer.update(this.delta * 0.75);
          }

          this.thirdPersonCameraUpdate(timeElapsed);
          this.movePlayer();
          this.playersAnim.update();
          //this.moveVillagers();
          this.Villagers.update();
          //console.log(this.player.boundingBox);

          //if (this.playerBB)
          //  this.playerBB
          //  .applyMatrix4(this.player.matrixWorld);
          //.copy(this.player.geometry.boundingBox)

          // this.updateMovement();
          // this.updateJump();

          if (this.dynamicsWorld) this.updatePhysics(timeElapsed);
        }
      }

      window.addEventListener("DOMContentLoaded", () => {
        window.mobileAndTabletCheck = function () {
          let check = false;
          (function (a) {
            if (
              /(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(
                a
              ) ||
              /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(
                a.substr(0, 4)
              )
            )
              check = true;
          })(navigator.userAgent || navigator.vendor || window.opera);
          return check;
        };
        console.log(window.mobileAndTabletCheck());
        Ammo().then((lib) => {
          Ammo = lib;
          let app = new App();
        });
      });
    </script>
  </head>
  <body>
    <div id="info"></div>
    <div id="gridSelector">
      <button id="showBuildMenu">Build Menu</button>
      <button id="showCollectMenu">Collect Menu</button>
      <div id="buildMenu">
        <button id="buildHouse">
          <img src="/img/house.png" width="80px" />
          <p class="buildable">
            50<img src="/img/wood.png" width="30px" /> Build House
          </p>
        </button>
        <button id="buildMine">
          <img src="/img/mine.png" width="80px" />
          <p class="buildable">
            50<img src="/img/Andesite.png" width="30px" /> Build Mine
          </p>
        </button>
        <button id="buildBlacksmithHouse">
          <img src="/img/blacksmith_house.png" width="80px" />
          <p class="buildable">
            50<img src="/img/Andesite.png" width="30px" /> Build Blacksmith
            House
          </p>
        </button>
        <button id="buildShop">
          <img src="/img/shop-icon.png" width="80px" />
          <p class="buildable">
            50<img src="/img/Andesite.png" width="30px" /> Build Shop
          </p>
        </button>
      </div>
      <div id="collectMenu">
        <p id="noVillagerText">
          You don't have esclaves. <br />You can build a house
        </p>
      </div>
    </div>
    <div id="resources">
      <div id="wood">
        <label for="">WOOD</label>
        <img src="/img/wood.png" width="50" height="50" />
        <label for="" id="woodCount">500</label>
      </div>
      <div id="stone">
        <label for="">STONE</label>
        <img src="/img/Andesite.png" width="50" height="50" />
        <label for="" id="stoneCount">500</label>
      </div>
      <div id="iron">
        <label for="">IRON</label>
        <img src="/img/Iron_Ingot.png" width="50" height="50" />
        <label for="" id="ironCount">0</label>
      </div>
      <div id="coal">
        <label for="">COAL</label>
        <img src="/img/Coal.png" width="50" height="50" />
        <label for="" id="coalCount">0</label>
      </div>
    </div>
    <div id="error"></div>
    <div id="menu">
      <h1>The World of Capitalists</h1>
      <h2>Discover, Build and Fight</h2>
      <button id="start_game">Jump in the World</button>
    </div>
    <div id="selectMenu">
      <h1 class="joinParty">Join Party</h1>
      <div id="partyList">Party</div>
      <div class="createParty">
        <!--<button id="createParty" class="startGame">Create your party</button>-->
        <button
          type="button"
          class="btn btn-primary"
          data-bs-toggle="modal"
          data-bs-target="#exampleModal"
          data-bs-whatever="@getbootstrap"
        >
          Create Party
        </button>

        <div
          class="modal fade"
          id="exampleModal"
          tabindex="-1"
          aria-labelledby="exampleModalLabel"
          aria-hidden="true"
        >
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">New Party</h5>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"
                ></button>
              </div>
              <div class="modal-body">
                <form>
                  <div class="form-group">
                    <label for="recipient-name" class="col-form-label"
                      >Party Name</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="recipient-name"
                    />
                  </div>
                  <div class="form-group">
                    <label for="recipient-seed" class="col-form-label"
                      >Seed</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="recipient-seed"
                      placeholder="0"
                    />
                  </div>
                  <div class="form-row">
                    <div class="form-group col-md-6">
                      <label for="recipient-size-x">Map size X:</label>
                      <input
                        placeholder="20"
                        type="number"
                        class="form-control"
                        id="recipient-size-x"
                      />
                    </div>
                    <div class="form-group col-md-6">
                      <label for="recipient-size-z">Map size Z:</label>
                      <input
                        placeholder="20"
                        type="number"
                        class="form-control"
                        id="recipient-size-z"
                      />
                    </div>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal"
                >
                  Close
                </button>
                <button
                  type="button"
                  class="btn btn-primary startGame"
                  data-bs-dismiss="modal"
                >
                  Create Party
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="loadingScreen">
      <img
        src="/img/Ecran_de_chargement.jpg"
        id="loadingScreen"
        alt=""
        srcset=""
      />
      <p>Loading...</p>
    </div>
    <div class="inventory">
      <div
        class="modal fade"
        id="inventory"
        data-bs-backdrop="static"
        data-bs-keyboard="false"
        tabindex="-1"
        aria-labelledby="inventoryLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="inventoryLabel">Inventory</h5>

              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body inventoryContent">
              <div class="itemCount">
                <button
                  class="inventoryItem"
                  data-bs-toggle="tooltip"
                  data-bs-placement="top"
                  data-bs-custom-class="custom-tooltip"
                  data-bs-title="This top tooltip is themed via CSS variables."
                >
                  <img src="/img/wood.png" alt="" />
                </button>
                50
              </div>
              <div class="itemCount">
                <button
                  class="inventoryItem"
                  data-bs-toggle="tooltip"
                  data-bs-placement="top"
                  data-bs-custom-class="custom-tooltip"
                  data-bs-title="This top tooltip is themed via CSS variables."
                >
                  <img src="/img/wood.png" alt="" />
                </button>
                50
              </div>
              <div class="itemCount">
                <button
                  class="inventoryItem"
                  data-bs-toggle="tooltip"
                  data-bs-placement="top"
                  data-bs-custom-class="custom-tooltip"
                  data-bs-title="This top tooltip is themed via CSS variables."
                >
                  <img src="/img/wood.png" alt="" />
                </button>
                50
              </div>
              <div class="itemCount">
                <button
                  class="inventoryItem"
                  data-bs-toggle="tooltip"
                  data-bs-placement="top"
                  data-bs-custom-class="custom-tooltip"
                  data-bs-title="This top tooltip is themed via CSS variables."
                >
                  <img src="/img/wood.png" alt="" />
                </button>
                50
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modalShop">
      <div
        class="modal fade"
        id="lootbox"
        aria-hidden="true"
        aria-labelledby="lootboxLabel"
        tabindex="-1"
      >
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <nav>
                <div class="nav nav-tabs" id="nav-tab" role="tablist">
                  <button
                    class="nav-link active"
                    id="nav-home-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#nav-home"
                    type="button"
                    role="tab"
                    aria-controls="nav-home"
                    aria-selected="true"
                  >
                    Lootbox
                  </button>
                  <button
                    class="nav-link"
                    id="nav-profile-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#nav-profile"
                    type="button"
                    role="tab"
                    aria-controls="nav-profile"
                    aria-selected="false"
                  >
                    Shop
                  </button>
                  <button
                    class="nav-link"
                    id="nav-contact-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#nav-contact"
                    type="button"
                    role="tab"
                    aria-controls="nav-contact"
                    aria-selected="false"
                  >
                    Autre
                  </button>
                </div>
              </nav>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <div class="tab-content" id="nav-tabContent">
                <div
                  class="tab-pane fade show active"
                  id="nav-home"
                  role="tabpanel"
                  aria-labelledby="nav-home-tab"
                >
                  <button class="produit lootbox" lb-lv="1">
                    <img src="/img/lootbox-lv1.png" alt="" />
                    50€
                  </button>

                  <button class="produit lootbox" lb-lv="2">
                    <img src="/img/lootbox-lv2.png" alt="" />
                    50€
                  </button>

                  <button class="produit lootbox" lb-lv="3">
                    <img src="/img/lootbox-lv3.png" alt="" />
                    50€
                  </button>

                  <button class="produit lootbox" lb-lv="4">
                    <img src="/img/lootbox-lv4.png" alt="" />
                    50€
                  </button>

                  <button class="produit lootbox" lb-lv="5">
                    <img src="/img/lootbox-lv5.png" alt="" />
                    50€
                  </button>
                </div>
                <div
                  class="tab-pane fade"
                  id="nav-profile"
                  role="tabpanel"
                  aria-labelledby="nav-profile-tab"
                >
                  <button class="produit">
                    <img src="/img/wood.png" alt="" />
                    50€
                  </button>
                </div>
                <div
                  class="tab-pane fade"
                  id="nav-contact"
                  role="tabpanel"
                  aria-labelledby="nav-contact-tab"
                >
                  ...
                </div>
              </div>
            </div>
            <div class="modal-footer"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="echap">
      <p>Press ECHAP to exit</p>
    </div>
    <div class="joystick">
      <canvas id="joystick" name="game"></canvas>
    </div>
    <div id="openingScene"></div>
    <div id="three" oncontextmenu="return false"></div>
  </body>
</html>
